<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>GP DrawTest — Config Hub</title>
<script src="gp_drawtest_config.js"></script>
<style>
* { box-sizing: border-box; margin: 0; padding: 0; }
body { background: #0a0a0a; color: #ccc; font-family: monospace; min-height: 100vh; }

nav {
  background: #111; border-bottom: 1px solid #222; padding: 8px 20px;
  display: flex; align-items: center; gap: 20px; font-size: 12px;
}
nav a    { color: #0f8; text-decoration: none; padding: 3px 8px; border: 1px solid #1a3a1a; }
nav a:hover { background: #0f8; color: #000; }
nav .active { color: #fa0; border-bottom: 2px solid #fa0; padding-bottom: 2px; }

#page { max-width: 680px; margin: 40px auto; padding: 0 20px; }
h1 { color: #0f8; font-size: 13px; letter-spacing: 2px; margin-bottom: 6px; }
.subtitle { color: #444; font-size: 11px; margin-bottom: 28px; }

section { margin-bottom: 28px; }
section h2 { font-size: 11px; color: #555; letter-spacing: 1px; border-bottom: 1px solid #1a1a1a; padding-bottom: 5px; margin-bottom: 14px; }

/* config grid */
.cfg-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px 24px; }
.cfg-row  { display: flex; flex-direction: column; gap: 4px; }
.cfg-row label { font-size: 10px; color: #555; letter-spacing: 1px; }
.cfg-row .ctrl-line { display: flex; align-items: center; gap: 8px; }
.cfg-row input[type=range]  { flex: 1; accent-color: #0f8; }
.cfg-row input[type=number] { width: 60px; background: #141414; border: 1px solid #2a2a2a; color: #0f8; font-family: monospace; font-size: 11px; padding: 3px 5px; }
.cfg-row .val { color: #0f8; min-width: 36px; font-size: 11px; }
.cfg-row .derived { color: #444; font-size: 10px; margin-top: 2px; }

/* module height table */
.h-table { border-collapse: collapse; font-size: 11px; width: 100%; }
.h-table th { text-align: left; color: #444; font-weight: normal; padding: 3px 8px 3px 0; }
.h-table td { color: #0f8; padding: 3px 8px 3px 0; }
.h-table .dim { color: #fa0; }

/* nav cards */
.cards { display: flex; gap: 14px; }
.card {
  flex: 1; padding: 16px; background: #0d0d0d; border: 1px solid #1e1e1e;
  text-decoration: none; color: inherit; transition: border-color 0.15s;
}
.card:hover { border-color: #0f8; }
.card h3 { color: #0f8; font-size: 12px; margin-bottom: 4px; }
.card .v2  { color: #c87800; font-size: 10px; }
.card .v3  { color: #00b4dc; font-size: 10px; }
.card .ports { color: #444; font-size: 10px; margin-top: 6px; }

/* style grid */
.style-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; }
.style-row  { display: flex; flex-direction: column; gap: 4px; }
.style-row label { font-size: 10px; color: #555; letter-spacing: 1px; }
.style-row select {
  background: #141414; border: 1px solid #2a2a2a; color: #0f8;
  font-family: monospace; font-size: 11px; padding: 4px 6px;
}
.style-row .hint { font-size: 9px; color: #333; margin-top: 2px; }

/* file link */
#fileBar {
  display: flex; align-items: center; gap: 12px; padding: 10px 14px;
  background: #0d0d0d; border: 1px solid #1a1a1a; margin-bottom: 10px;
}
.fbtn {
  padding: 3px 10px; border: 1px solid #333; background: #111;
  color: #666; font-family: monospace; font-size: 11px; cursor: pointer; white-space: nowrap;
}
.fbtn:hover { border-color: #0f8; color: #0f8; }
.fbtn.linked { border-color: #0f8; color: #0f8; background: #0a1a0a; }
#fileStatus { font-size: 10px; color: #444; flex: 1; }
#saveFlash  { font-size: 10px; color: #0f8; opacity: 0; transition: opacity 0.3s; }

/* copy box */
#copyBox {
  background: #0d0d0d; border: 1px solid #1a2a1a; padding: 10px 14px;
  font-size: 11px; color: #0a8; white-space: pre; line-height: 1.6;
}
.copy-btn {
  margin-top: 8px; padding: 3px 10px; background: #1a2a1a; border: 1px solid #0f8;
  color: #0f8; font-family: monospace; font-size: 11px; cursor: pointer;
}
.copy-btn:hover { background: #0f8; color: #000; }
.copy-note { font-size: 10px; color: #444; margin-top: 6px; }

/* live preview */
.prev-controls {
  display: flex; align-items: center; gap: 8px; margin-bottom: 10px; flex-wrap: wrap;
}
.prev-canvases { display: flex; gap: 16px; overflow-x: auto; }
.prev-canvases canvas { display: block; image-rendering: pixelated; }
.clabel { font-size: 9px; margin-bottom: 3px; letter-spacing: 0.5px; }
.v2lbl  { color: #c87800; }
.v3lbl  { color: #00b4dc; }
.pbtn {
  padding: 2px 10px; background: #111; border: 1px solid #333;
  color: #666; font-family: monospace; font-size: 12px; cursor: pointer;
}
.pbtn:hover        { border-color: #0f8; color: #0f8; }
.pbtn.active       { border-color: #0f8; color: #0f8; background: #0a1a0a; }
#prevFamily {
  background: #141414; border: 1px solid #2a2a2a; color: #0f8;
  font-family: monospace; font-size: 11px; padding: 3px 6px;
}
#prevPct { flex: 1; min-width: 80px; accent-color: #0f8; }
#prevPctVal { color: #0f8; font-size: 11px; min-width: 36px; }
</style>
</head>
<body>

<nav>
  <span class="active">⚙ Config</span>
  <a href="drawtest-ssh.html">SSHcrack</a>
  <a href="drawtest-ftp.html">FTPBounce</a>
  <a href="drawtest-web.html">WebServerWorm</a>
</nav>

<div id="page">
  <h1>GP DRAWTEST — CONFIG HUB</h1>
  <p class="subtitle">Tweak values here. Open a cracker tab — it live-updates via localStorage.</p>

  <!-- ── CONFIG ── -->
  <section>
    <h2>DRAW PARAMS  (mirrors DrawTestParams in GatekeeperProtocol.cs)</h2>
    <div class="cfg-grid">
      <div class="cfg-row">
        <label>HEADER H</label>
        <div class="ctrl-line">
          <input type="range" id="headerH" min="16" max="48" value="28">
          <span class="val" id="headerHVal">28</span>
        </div>
        <div class="derived">px below module top where matrix starts</div>
      </div>
      <div class="cfg-row">
        <label>TARGET ROWS</label>
        <div class="ctrl-line">
          <input type="range" id="targetRows" min="1" max="12" value="6">
          <span class="val" id="targetRowsVal">6</span>
        </div>
        <div class="derived">rows the animation always tries to show</div>
      </div>
      <div class="cfg-row">
        <label>RAM COST V2</label>
        <div class="ctrl-line">
          <input type="number" id="ramCostV2" min="1" max="512" value="256">
        </div>
        <div class="derived">SSH/FTP/Web V2 ramCost</div>
      </div>
      <div class="cfg-row">
        <label>RAM COST V3</label>
        <div class="ctrl-line">
          <input type="number" id="ramCostV3" min="1" max="512" value="384">
        </div>
        <div class="derived">SSH/FTP/Web V3 ramCost</div>
      </div>
      <div class="cfg-row">
        <label>ACCENT H</label>
        <div class="ctrl-line">
          <input type="range" id="accentH" min="1" max="8" value="3">
          <span class="val" id="accentHVal">3</span>
        </div>
        <div class="derived">tier-color bar height at bottom of header (px)</div>
      </div>
      <div class="cfg-row">
        <label>LABEL OFFSET</label>
        <div class="ctrl-line">
          <input type="range" id="labelOffset" min="10" max="80" value="40">
          <span class="val" id="labelOffsetVal">40</span>
        </div>
        <div class="derived">header text baseline = headerH − labelOffset</div>
      </div>
      <div class="cfg-row">
        <label>CHAR W  <span style="color:#333">(approx tinyfont)</span></label>
        <div class="ctrl-line">
          <input type="range" id="charW" min="4" max="14" value="6">
          <span class="val" id="charWVal">6</span>
        </div>
      </div>
      <div class="cfg-row">
        <label>CHAR H  <span style="color:#333">(approx tinyfont)</span></label>
        <div class="ctrl-line">
          <input type="range" id="charH" min="6" max="18" value="11">
          <span class="val" id="charHVal">11</span>
        </div>
      </div>
    </div>
  </section>

  <!-- ── LIVE PREVIEW ── -->
  <section>
    <h2>LIVE PREVIEW  <span style="color:#333;font-size:9px;font-weight:normal">— updates on every slider change</span></h2>
    <div class="prev-controls">
      <select id="prevFamily">
        <option value="ssh">SSHcrack</option>
        <option value="ftp">FTPBounce</option>
        <option value="web">WebServerWorm</option>
      </select>
      <span style="color:#444;font-size:10px">progress</span>
      <input type="range" id="prevPct" min="0" max="100" value="45">
      <span id="prevPctVal">45%</span>
      <button class="pbtn" id="prevPlay">▶</button>
      <button class="pbtn" id="prevRestart">⟳</button>
    </div>
    <div class="prev-canvases">
      <div>
        <div class="clabel v2lbl" id="prevLabelV2">SSHcrack_v2 · :22 · 10s · no key</div>
        <canvas id="prevV2" width="220" height="150"></canvas>
      </div>
      <div>
        <div class="clabel v3lbl" id="prevLabelV3">SSHcrack_v3 · :20022 · 15s · [KEY]</div>
        <canvas id="prevV3" width="220" height="225"></canvas>
      </div>
    </div>
  </section>

  <!-- ── MODULE HEIGHT PREVIEW ── -->
  <section>
    <h2>ESTIMATED MODULE HEIGHT</h2>
    <div style="display:flex;gap:20px;align-items:flex-start;margin-bottom:12px">
      <div class="cfg-row" style="min-width:160px">
        <label>PLAYER RAM</label>
        <div class="ctrl-line">
          <select id="playerRam" style="background:#141414;border:1px solid #2a2a2a;color:#0f8;font-family:monospace;font-size:11px;padding:3px 5px">
            <option value="256">256 MB</option>
            <option value="512" selected>512 MB</option>
            <option value="1024">1024 MB</option>
            <option value="2048">2048 MB</option>
          </select>
        </div>
      </div>
      <div class="cfg-row" style="min-width:160px">
        <label>PANEL FULL H</label>
        <div class="ctrl-line">
          <select id="panelFullH" style="background:#141414;border:1px solid #2a2a2a;color:#0f8;font-family:monospace;font-size:11px;padding:3px 5px">
            <option value="280">280 px (1080p)</option>
            <option value="300" selected>300 px (approx)</option>
            <option value="340">340 px (tall)</option>
          </select>
        </div>
      </div>
    </div>
    <table class="h-table">
      <thead><tr><th>Exe</th><th>Tier</th><th>ramCost</th><th>Module H</th><th>Content H</th><th>Scale</th><th>Rows</th></tr></thead>
      <tbody id="heightTable"></tbody>
    </table>
  </section>

  <!-- ── OPEN CRACKER ── -->
  <section>
    <h2>OPEN CRACKER PREVIEW</h2>
    <div class="cards">
      <a class="card" href="drawtest-ssh.html">
        <h3>SSHcrack →</h3>
        <div class="v2">V2 — port 22 — 10s — orange</div>
        <div class="v3">V3 — port 20022 — 15s — cyan [KEY]</div>
        <div class="ports">Variants: vanilla_clone · column_sweep · waveform</div>
      </a>
      <a class="card" href="drawtest-ftp.html">
        <h3>FTPBounce →</h3>
        <div class="v2">V2 — port 21 — 10s — orange</div>
        <div class="v3">V3 — port 20021 — 15s — cyan [KEY]</div>
        <div class="ports">Variants: vanilla_clone · packet_rows · bounce_stream</div>
      </a>
      <a class="card" href="drawtest-web.html">
        <h3>WebServerWorm →</h3>
        <div class="v2">V2 — port 80 — 10s — orange</div>
        <div class="v3">V3 — port 20080 — 15s — cyan [KEY]</div>
        <div class="ports">Variants: vanilla_clone · http_headers · spiral_unlock</div>
      </a>
    </div>
  </section>

  <!-- ── DRAW STYLES ── -->
  <section>
    <h2>DRAW STYLE PER EXE  (sshStyle / ftpStyle / webStyle in cfg)</h2>
    <div class="style-grid">
      <div class="style-row">
        <label>SSH STYLE</label>
        <select id="sshStyle">
          <option value="matrix">matrix</option>
          <option value="packets">packets</option>
          <option value="waveform">waveform</option>
        </select>
        <div class="hint">SSHcrack_v2 / v3</div>
      </div>
      <div class="style-row">
        <label>FTP STYLE</label>
        <select id="ftpStyle">
          <option value="matrix">matrix</option>
          <option value="packets" selected>packets</option>
        </select>
        <div class="hint">FTPBounce_v2 / v3</div>
      </div>
      <div class="style-row">
        <label>WEB STYLE</label>
        <select id="webStyle">
          <option value="matrix">matrix</option>
          <option value="packets">packets</option>
        </select>
        <div class="hint">WebServerWorm_v2 / v3</div>
      </div>
    </div>
    <div class="derived" style="margin-top:8px">
      <b>matrix</b> — random hex grid, threshold-based (vanilla SSHcrack feel)<br>
      <b>packets</b> — rows complete top→bottom, columns left→right (FTP data transfer feel)
    </div>
  </section>

  <!-- ── SAVE TO FILE ── -->
  <section>
    <h2>SAVE TO  BepInEx/plugins/gp_drawtest.cfg</h2>
    <div id="fileBar">
      <button class="fbtn" id="linkBtn">⌂ Link to cfg file…</button>
      <span id="fileStatus">No file linked. Click to pick gp_drawtest.cfg — then every change auto-saves.</span>
      <span id="saveFlash">✓ saved</span>
    </div>
    <div id="copyBox"></div>
    <button class="copy-btn" id="copyBtn">⎘ COPY</button>
    <div class="copy-note">
      Link the file once — then every slider/dropdown change writes directly to disk and Hacknet reloads within 1 second.<br>
      If your browser doesn't support File System Access, use ⎘ COPY and paste manually.
    </div>
  </section>
</div>

<script>
let cfg = gpLoadConfig();
let fileHandle = null;
let saveFlashTimer = null;

// ---- File System Access API -----------------------------------------------
async function linkFile() {
  try {
    [fileHandle] = await window.showOpenFilePicker({
      types: [{ description: 'Config', accept: { 'text/plain': ['.cfg'] } }],
      multiple: false,
    });
    document.getElementById('fileStatus').textContent =
      '✓ Linked: ' + fileHandle.name + ' — every change auto-saves';
    document.getElementById('linkBtn').textContent   = '✓ Linked';
    document.getElementById('linkBtn').classList.add('linked');
    await writeCfgFile(); // write current values immediately
  } catch (e) {
    if (e.name !== 'AbortError')
      document.getElementById('fileStatus').textContent = 'Error: ' + e.message;
  }
}

async function writeCfgFile() {
  if (!fileHandle) return;
  try {
    const writable = await fileHandle.createWritable();
    await writable.write(generateCfgContent());
    await writable.close();
    // flash confirmation
    const flash = document.getElementById('saveFlash');
    flash.style.opacity = 1;
    clearTimeout(saveFlashTimer);
    saveFlashTimer = setTimeout(() => { flash.style.opacity = 0; }, 1000);
  } catch (e) {
    document.getElementById('fileStatus').textContent = 'Save error: ' + e.message;
  }
}

function generateCfgContent() {
  return [
    '# Gatekeeper Protocol - Draw Test Config',
    '# Auto-saved from drawtest.html — changes apply within 1 second while Hacknet runs.',
    '# ramCostV2/V3 take effect on the next cracker spawn.',
    '',
    `headerH     = ${cfg.headerH}`,
    `targetRows  = ${cfg.targetRows}`,
    `ramCostV2   = ${cfg.ramCostV2}`,
    `ramCostV3   = ${cfg.ramCostV3}`,
    '',
    '# Header layout',
    `accentH     = ${cfg.accentH  ?? 3}`,
    `labelOffset = ${cfg.labelOffset ?? 11}`,
    '',
    '# Draw style per exe family: matrix | packets | waveform',
    `sshStyle    = ${cfg.sshStyle || 'matrix'}`,
    `ftpStyle    = ${cfg.ftpStyle || 'packets'}`,
    `webStyle    = ${cfg.webStyle || 'matrix'}`,
  ].join('\n') + '\n';
}

document.getElementById('linkBtn').addEventListener('click', linkFile);
if (!window.showOpenFilePicker) {
  document.getElementById('linkBtn').disabled = true;
  document.getElementById('fileStatus').textContent =
    'File System Access not supported in this browser. Use ⎘ COPY instead.';
}

// ---- bind sliders / inputs -----------------------------------------------
function onChange() { gpSaveConfig(cfg); refresh(); writeCfgFile(); reinitPreview(); renderPreview(); }

function bindRange(id, valId, key) {
  const el = document.getElementById(id);
  const vl = document.getElementById(valId);
  el.value = cfg[key] ?? el.value;
  if (vl) vl.textContent = el.value;
  el.addEventListener('input', () => {
    cfg[key] = parseInt(el.value);
    if (vl) vl.textContent = cfg[key];
    onChange();
  });
}
function bindNum(id, key) {
  const el = document.getElementById(id);
  el.value = cfg[key] ?? el.value;
  el.addEventListener('input', () => {
    const v = parseInt(el.value);
    if (!isNaN(v) && v > 0) { cfg[key] = v; onChange(); }
  });
}
function bindSelect(id, key, defaultVal) {
  const el = document.getElementById(id);
  el.value = cfg[key] || defaultVal;
  el.addEventListener('change', () => { cfg[key] = el.value; onChange(); });
}

bindRange('headerH',     'headerHVal',     'headerH');
bindRange('targetRows',  'targetRowsVal',  'targetRows');
bindRange('accentH',     'accentHVal',     'accentH');
bindRange('labelOffset', 'labelOffsetVal', 'labelOffset');
bindRange('charW',       'charWVal',       'charW');
bindRange('charH',       'charHVal',       'charH');
bindNum('ramCostV2', 'ramCostV2');
bindNum('ramCostV3', 'ramCostV3');
bindSelect('sshStyle', 'sshStyle', 'matrix');
bindSelect('ftpStyle', 'ftpStyle', 'packets');
bindSelect('webStyle', 'webStyle', 'matrix');

['playerRam', 'panelFullH'].forEach(id => {
  document.getElementById(id).addEventListener('change', () => { reinitPreview(); renderPreview(); refresh(); });
});

// ---- refresh height table + copy box -------------------------------------
function refresh() {
  const playerRam  = parseInt(document.getElementById('playerRam').value);
  const panelFullH = parseInt(document.getElementById('panelFullH').value);
  const PANEL_W    = 220;

  const tbody = document.getElementById('heightTable');
  tbody.innerHTML = '';
  ['ssh_v2','ftp_v2','web_v2','ssh_v3','ftp_v3','web_v3'].forEach(key => {
    const cr     = GP_CRACKERS[key];
    const h      = gpModuleH(cfg, cr.tier, playerRam, panelFullH);
    const cr_    = gpGetColsRows(PANEL_W, h, cfg);
    const [cols, rows, scale] = cr_;
    const contentH = h - cfg.headerH - 4;
    const tr = document.createElement('tr');
    tr.innerHTML =
      `<td style="color:${cr.tier>=3?'#0af':'#fa0'}">${cr.label}</td>` +
      `<td>V${cr.tier}</td>` +
      `<td>${cr.tier>=3?cfg.ramCostV3:cfg.ramCostV2}</td>` +
      `<td class="dim">${h} px</td>` +
      `<td style="color:${contentH<=0?'#a00':'#666'}">${Math.max(0,contentH)} px</td>` +
      `<td>${scale.toFixed(2)}x</td>` +
      `<td>${rows}</td>`;
    tbody.appendChild(tr);
  });

  document.getElementById('copyBox').textContent = generateCfgContent();
}

document.getElementById('copyBtn').addEventListener('click', () => {
  navigator.clipboard?.writeText(generateCfgContent())
    .then(() => { document.getElementById('copyBtn').textContent = '✓ COPIED'; setTimeout(() => { document.getElementById('copyBtn').textContent = '⎘ COPY'; }, 1500); })
    .catch(() => {});
});

// ---- Live Preview --------------------------------------------------------
const PREV_W = 220;
let prevFamily  = 'ssh';
let prevPct     = 0.45;
let prevPlaying = false;
let prevLastT   = null;
let prevRaf     = null;
let prevStateV2 = null;
let prevStateV3 = null;

function getPrevCracker(v) { return GP_CRACKERS[prevFamily + '_v' + v]; }

function getPreviewStyle() {
  if (prevFamily === 'ftp') return cfg.ftpStyle || 'packets';
  if (prevFamily === 'web') return cfg.webStyle || 'matrix';
  return cfg.sshStyle || 'matrix';
}

function reinitPreview() {
  const playerRam  = parseInt(document.getElementById('playerRam').value);
  const panelFullH = parseInt(document.getElementById('panelFullH').value);
  const cv2 = document.getElementById('prevV2');
  const cv3 = document.getElementById('prevV3');
  cv2.height = gpModuleH(cfg, 2, playerRam, panelFullH);
  cv3.height = gpModuleH(cfg, 3, playerRam, panelFullH);
  const [c2, r2] = gpGetColsRows(PREV_W, cv2.height, cfg);
  const [c3, r3] = gpGetColsRows(PREV_W, cv3.height, cfg);
  prevStateV2 = gpInitGrid(c2, r2);
  prevStateV3 = gpInitGrid(c3, r3);
  const crV2 = getPrevCracker(2), crV3 = getPrevCracker(3);
  document.getElementById('prevLabelV2').textContent =
    crV2.label + ' · :' + crV2.port + ' · ' + crV2.solveTime + 's · ' + (crV2.key || 'no key');
  document.getElementById('prevLabelV3').textContent =
    crV3.label + ' · :' + crV3.port + ' · ' + crV3.solveTime + 's · ' + (crV3.key ? '[KEY]' : 'no key');
}

function renderPrevCanvas(canvasId, tier, state) {
  const canvas  = document.getElementById(canvasId);
  const cracker = getPrevCracker(tier);
  const ctx     = canvas.getContext('2d');
  const h       = canvas.height;
  const [cols, rows, , CW, CH] = gpGetColsRows(PREV_W, h, cfg);
  const accent = GP_TIER_CRACKED[cracker.tier];
  ctx.fillStyle = '#080808';
  ctx.fillRect(0, 0, PREV_W, h);
  if (rows > 0 && state) {
    const style = getPreviewStyle();
    const cX = 4, cY = cfg.headerH;
    if      (style === 'packets')  gpDrawPackets (ctx, state, cols, rows, prevPct, cX, cY, CW, CH, accent);
    else if (style === 'waveform') gpDrawWaveform(ctx, state, cols, rows, prevPct, cX, cY, CW, CH, accent);
    else                           gpDrawMatrix  (ctx, state, cols, rows, prevPct, cX, cY, CW, CH, accent);
  }
  gpDrawHeader(ctx, cracker, cfg, PREV_W);
  gpDrawOutline(ctx, cracker.tier, PREV_W, h);
}

function renderPreview() {
  if (!prevStateV2 || !prevStateV3) reinitPreview();
  renderPrevCanvas('prevV2', 2, prevStateV2);
  renderPrevCanvas('prevV3', 3, prevStateV3);
}

function prevFrame(ts) {
  if (!prevPlaying) { prevRaf = null; return; }
  if (prevLastT === null) prevLastT = ts;
  const dt = Math.min((ts - prevLastT) / 1000, 0.1);
  prevLastT = ts;

  prevPct = Math.min(1, prevPct + dt / getPrevCracker(2).solveTime);
  document.getElementById('prevPct').value = Math.round(prevPct * 100);
  document.getElementById('prevPctVal').textContent = Math.round(prevPct * 100) + '%';

  const cv2 = document.getElementById('prevV2'), cv3 = document.getElementById('prevV3');
  const [c2, r2] = gpGetColsRows(PREV_W, cv2.height, cfg);
  const [c3, r3] = gpGetColsRows(PREV_W, cv3.height, cfg);
  const style = getPreviewStyle();
  const tick = style === 'packets'  ? gpTickFlickerPackets
             : style === 'waveform' ? gpTickFlickerWaveform
             :                        gpTickFlicker;
  tick(prevStateV2, dt, c2, r2, prevPct);
  tick(prevStateV3, dt, c3, r3, prevPct);

  renderPreview();

  if (prevPct >= 1) {
    prevPlaying = false;
    const btn = document.getElementById('prevPlay');
    btn.textContent = '▶'; btn.classList.remove('active');
    setTimeout(() => {
      prevPct = 0;
      document.getElementById('prevPct').value = 0;
      document.getElementById('prevPctVal').textContent = '0%';
      reinitPreview(); renderPreview();
    }, 600);
    prevRaf = null;
    return;
  }
  prevRaf = requestAnimationFrame(prevFrame);
}

document.getElementById('prevFamily').addEventListener('change', e => {
  prevFamily = e.target.value; reinitPreview(); renderPreview();
});
document.getElementById('prevPct').addEventListener('input', e => {
  prevPct = parseInt(e.target.value) / 100;
  document.getElementById('prevPctVal').textContent = e.target.value + '%';
  if (!prevStateV2) reinitPreview();
  renderPreview();
});
document.getElementById('prevPlay').addEventListener('click', () => {
  prevPlaying = !prevPlaying;
  const btn = document.getElementById('prevPlay');
  btn.textContent = prevPlaying ? '⏸' : '▶';
  btn.classList.toggle('active', prevPlaying);
  if (prevPlaying) { prevLastT = null; if (!prevRaf) prevRaf = requestAnimationFrame(prevFrame); }
});
document.getElementById('prevRestart').addEventListener('click', () => {
  prevPlaying = false;
  const btn = document.getElementById('prevPlay');
  btn.textContent = '▶'; btn.classList.remove('active');
  prevPct = 0;
  document.getElementById('prevPct').value = 0;
  document.getElementById('prevPctVal').textContent = '0%';
  reinitPreview(); renderPreview();
});

// ---- init ----------------------------------------------------------------
reinitPreview();
renderPreview();
refresh();
</script>
</body>
</html>
